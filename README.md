# Описание

Backend-сервисы предназначены для обработки запрос от UI и других сервисов.

Solution делится на следующий части:
1) `Common` - общие библиотеки для всех проектов. В последующем будет выноситься в отдельные nuget-пакеты.
2) `Files` - микросервис для работы с файлами. Для хранения файлов используется s3 хранилище. В локальной среде это MinIO, на стендах - Yandex cloud object storage.
3) `Notification` - микросервис для работы с уведомлениями. Получает шаблон уведомления от `Static`, параметризирует и отправляет на почту через `Exchange`, но если включено параметром, если выключено пишет в лог текст письма.
4) `Partners` - проект отвечающий за работу с партнерами и клубом привилегий. Содержит базу данных.
5) `PersonalAccount` - проект для работы с данными пользователей. На данном этапе это только избранные пользователя. Содержит базу данных.
6) `Security` отвечает за идентификацию, аутентификацию, авторизацию пользователей. Для работы с пользователями интегрируется с `keycloak`.
7) `Static` содержит статичные файлы. Кэширует ответы.  
![Realm](./documents/readme/scheme.png)

-------------  
- `Api` могут в зависимостях иметь только два типа проектов: `Contracts` и `Handlers`. Для обработки сервисов извне(например, ui) созданы проекты с постфиксом `Public.Api`, например: `Kortros.Security.Public.Hosts.Api`. Для обработки внутренних запросов создаются проекты с постфиксом `Private.Api`, например: `Kortros.Notification.Private.Hosts.Api`. При этом Public сервисы работают с авторизацией через `Keycloak`, а Private сервисы проверяют доверенные сети
- `Migrations` проекты с миграциями и Seed'ами.
- `Hanlders` имеют в зависимостях `AppSettings`, в которых находятся основные сервисы бизнес-логики. При этом следует заметить, что обработка команд происходит в транзакции и елси требуются вычисления или действия, которые должны выполняться за транзакцией, например отправка уведомления, то необходимо добавлять в `IEventMessageProvider` событие для обработки отправки уведомления(смотреть `UpdateUserRequestHandler`)
- `AppSettings` содержат сервисы для бизнес-логики, могут инжектить `IRepository` для работы с базой данных.
- `Domain` содержат классы сущности таблиц БД.
- `Contracts` содержат контракты для общения с внешними источниками.
- `Clients` содержит реализацию клиентов для доступа к сервису. Данный проект будет публиковаться nuget-пакетом в хранилище для других сервисов, чтобы они могли общаться с этим сервисов посредством обычного вызова метода.
- `Infrastructures.DataAccess` проекты для конфигураций работы с базой данных.
- `Tests` проект с тестами, от этого проекта никто не должен зависеть.

Возможные зависимости между проектами:
|                 | Api | Hanlders | AppSettings | Domain | Contracts | Clients | Infrastructures | Tests |
|-----------------|-----|----------|-------------|--------|-----------|---------|-----------------|-------|
| Api             |  \  |     +    |             |        |     +     |         |                 |       |
| Hanlders        |     |     \    |      +      |        |     +     |    +    |                 |       |
| AppSettings     |     |          |      \      |    +   |     +     |    +    |        +        |       |
| Domain          |     |          |             |    \   |           |         |                 |       |
| Contracts       |     |          |             |        |     \     |         |                 |       |
| Clients         |     |          |             |        |     +     |    \    |                 |       |
| Infrastructures |     |          |             |    +   |           |         |        \        |       |
| Tests           |  +  |     +    |      +      |    +   |     +     |    +    |        +        |   \   |

<span style="font-weight: bold; color: red;">Придерживая микросервисной архитектуре, отдельные сервисы общаются с другими сервисами только через HTTP/GRPC/брокеры. Т.е. проекты сервисы могут иметь в зависимостях только проекты `Contracts` и `Clients` других сервисов.</span>

Проект `AppSettings` внутри себя делит бизнес-логику на контексты, например  в проекте `Partners` следующие контексты: 
- `Categories`: Категории партнеров
- `Partners`: Партнеры
- `Transactions`: Транзакции получения купона партнера
Внутри контекста логика делится на более мелкие структурные части, например:
- `Models`: сущности, используемые только в бизнес-логике. Содержит промежуточные классы. Например, партнер содержит большое количество свойств и `Handler` не может передать сущность команды или запроса в сервис, т.к. у `AppService` нет зависимости от `Handler`, поэтому данные мапятся в сущность модели и передаётся в сервис.
- `Services`: логика обработки запроса
- `Factories`: фабрики
- `StateMachines`: машины-состояний
- и т.д.

# Рекомендации

- Установить расширение на студию SonarLint (проверяет style-code и неявные ошибки)
- Установить расширение на студию Fine Code Coverage (для проверки покрытия кода тестами)

# Работа с ветками по Gitflow:  
<img src="./documents/readme/git-flow.png" alt="GitFlow" width="600" height="800">